generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model UserWallet {
  id           String        @id @default(uuid())
  clerkId      String        @unique
  balance      Int           @default(0) // Stored in 'credits' (100 = $1.00)
  transactions Transaction[]
}

model Transaction {
  id          String     @id @default(uuid())
  walletId    String
  wallet      UserWallet @relation(fields: [walletId], references: [id])
  amount      Int // Negative for usage, positive for top-up
  description String
  metadata    Json?
  createdAt   DateTime   @default(now())
}

model UserProfile {
  id          String  @id @default(uuid())
  clerkId     String  @unique
  websiteUrl  String?
  brandConfig Json? // Stores extracted logo, fonts, colors (The Mirror)

  // Encrypted Keys (The Vault)
  googleApiKey       String? // Google AI Studio / Gemini Key
  shopifyAccessToken String? // For Shopify sync
  redditApiKey       String? // For Reddit scraping/posting
  socialApiKeys      Json? // Encrypted map of other social keys (X, LinkedIn, etc.)

  // Vault Security (Phase 9.1)
  keyVersion         Int   @default(1) // Current encryption key version
  keyRotationHistory Json? // Audit trail of key rotations: [{ version, rotatedAt, rotatedBy }]

  integrations        Json? // Connection status & metadata
  onboardingCompleted Boolean @default(false)

  tasks KanbanTask[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model KanbanTask {
  id      String      @id @default(uuid())
  clerkId String
  profile UserProfile @relation(fields: [clerkId], references: [clerkId])

  title       String
  description String?
  status      String  @default("OBLIGATION") // OBLIGATION, EXECUTION, VALIDATION, ARCHIVE
  priority    String  @default("MEDIUM") // LOW, MEDIUM, HIGH, KINETIC

  dueDate   DateTime?
  payload   Json? // Mission data (tool options, specs)
  resultUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// v8.2 Mission Persistence
model Mission {
  id         String   @id @default(uuid())
  status     String // PENDING, RUNNING, COMPLETED, FAILED
  plan       Json?
  result     Json?
  audit      Json? // Independent Verification Report
  cost       Int // Total cost in credits
  agentCosts Json? // Phase 9.2: Per-agent cost breakdown { agentName: { tokens, cost, duration } }
  userId     String // Corresponds to clerkId/User ID
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// Phase 4: Cross-Mission Intelligence
model MissionLearning {
  id           String   @id @default(uuid())
  missionType  String // Classification: marketing, seo, content, research, etc.
  agentsUsed   String[] // List of agent names used in this mission
  success      Boolean // Whether mission completed successfully
  duration     Int // Duration in milliseconds
  retryCount   Int // Number of retries needed
  insights     String[] // Extracted insights and learnings
  qualityScore Float? // Quality score (0-100)
  failureMode  String? // If failed, what was the failure category
  timestamp    DateTime @default(now())

  @@index([missionType])
  @@index([success])
  @@index([timestamp])
}

// UNI-167: Task Queue & Scheduling System
model QueueJob {
  id           String    @id @default(uuid())
  queue        String // e.g. "missions", "agents", "maintenance"
  name         String // job name/type
  status       String    @default("waiting") // waiting, active, completed, failed, delayed
  priority     Int       @default(0) // BullMQ: lower = higher priority (0 is highest)
  payload      Json
  result       Json?
  error        String?
  attempts     Int       @default(0)
  maxAttempts  Int       @default(3)
  scheduledFor DateTime?
  startedAt    DateTime?
  completedAt  DateTime?
  userId       String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([queue, status])
  @@index([userId])
  @@index([scheduledFor])
}

model CronSchedule {
  id        String    @id @default(uuid())
  name      String // human-readable identifier
  pattern   String // cron expression: "0 */6 * * *"
  queue     String // target queue
  jobName   String // job type to create
  payload   Json
  isActive  Boolean   @default(true)
  nextRunAt DateTime?
  lastRunAt DateTime?
  userId    String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([name, userId])
  @@index([isActive, nextRunAt])
}

model DeadLetterEntry {
  id         String    @id @default(uuid())
  queue      String
  jobName    String
  bullmqId   String? // original BullMQ job ID
  payload    Json
  error      String
  attempts   Int
  failedAt   DateTime  @default(now())
  resolvedAt DateTime? // null = unresolved
  userId     String

  @@index([queue])
  @@index([userId])
  @@index([resolvedAt])
}

// UNI-169: API Gateway & External Integrations
// ─── API Gateway ────────────────────────────────────────────────────────

model ApiKey {
  id        String   @id @default(uuid())
  name      String
  keyHash   String   @unique // SHA-256 hash of API key
  keyPrefix String // First 15 chars (e.g., "gp_live_abc1234")
  scopes    String[] // ["missions:read", "agents:execute"]
  userId    String

  rateLimitTier String  @default("standard") // standard, premium, enterprise
  isActive      Boolean @default(true)

  lastUsedAt DateTime?
  expiresAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([keyPrefix])
}

model RateLimitBucket {
  id         String @id @default(uuid())
  identifier String // userId, IP, or API key hash
  endpoint   String // "/api/agents", "*" for global

  requestCount Int      @default(0)
  windowStart  DateTime

  @@unique([identifier, endpoint])
  @@index([windowStart])
}

// ─── Webhooks ───────────────────────────────────────────────────────────

model WebhookEndpoint {
  id     String @id @default(uuid())
  url    String
  secret String // Encrypted HMAC secret

  events   String[] // ["mission.completed", "wallet.topup"]
  isActive Boolean  @default(true)

  userId   String
  metadata Json?

  deliveries WebhookDelivery[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, isActive])
}

model WebhookDelivery {
  id         String          @id @default(uuid())
  endpointId String
  endpoint   WebhookEndpoint @relation(fields: [endpointId], references: [id])

  eventType String // "mission.completed"
  payload   Json

  status      String @default("pending") // pending, sent, failed, retrying
  attempts    Int    @default(0)
  maxAttempts Int    @default(3)

  responseCode Int?
  responseBody String?
  error        String?

  sentAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([endpointId, status])
  @@index([createdAt])
}

// ─── Connectors ─────────────────────────────────────────────────────────

model ConnectorState {
  id            String @id @default(uuid())
  connectorName String @unique // "stripe", "google-slides"

  isHealthy    Boolean   @default(true)
  failureCount Int       @default(0)
  lastFailure  DateTime?
  circuitState String    @default("closed") // closed, open, half-open

  metadata Json?

  lastCheckedAt DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([isHealthy, circuitState])
}

// ─── UNI-168: Monitoring Dashboard ─────────────────────────────────────

// Alert Rule Definition
model AlertRule {
  id          String  @id @default(uuid())
  name        String
  description String?

  // Rule type and configuration
  ruleType  String // threshold, rate_of_change
  metric    String // error_rate, queue_depth, cost_per_hour
  condition String // gt, lt, gte, lte
  threshold Float

  // Evaluation window
  windowMinutes Int @default(5)

  // Alert channels
  channels   String[] // ["webhook", "email"]
  webhookIds String[] // Webhook endpoint IDs

  // State
  isActive    Boolean   @default(true)
  isFiring    Boolean   @default(false)
  lastFiredAt DateTime?

  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  firings AlertFiring[]

  @@index([userId, isActive])
  @@index([isFiring])
}

// Alert Firing History
model AlertFiring {
  id     String    @id @default(uuid())
  ruleId String
  rule   AlertRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  triggeredAt DateTime  @default(now())
  resolvedAt  DateTime?

  metricValue Float
  message     String
  metadata    Json?

  notificationsSent String[]

  userId String

  @@index([ruleId, resolvedAt])
  @@index([triggeredAt])
  @@index([userId])
}

// Metrics Snapshot (time-series)
model MetricSnapshot {
  id String @id @default(uuid())

  timestamp DateTime // Rounded to nearest minute

  // Queue metrics
  queueDepth    Int @default(0)
  activeJobs    Int @default(0)
  failedJobs    Int @default(0)
  completedJobs Int @default(0)

  // Agent metrics
  activeAgents Int @default(0)
  idleAgents   Int @default(0)

  // Throughput
  jobsPerMinute Float @default(0)

  // Cost
  costPerHour     Float @default(0)
  tokensPerMinute Float @default(0)

  // Errors
  errorRate Float @default(0)

  userId String

  @@unique([timestamp, userId])
  @@index([userId, timestamp])
}

// Agent Status Tracking
model AgentStatus {
  id        String @id @default(uuid())
  agentName String

  status String @default("idle") // idle, active, failed, unknown

  currentJobId String?
  startedAt    DateTime?

  lastActiveAt        DateTime @default(now())
  consecutiveFailures Int      @default(0)

  avgDuration     Float @default(0)
  totalExecutions Int   @default(0)

  userId    String
  updatedAt DateTime @updatedAt

  @@unique([agentName, userId])
  @@index([userId, status])
}

// ─── GEO Free Audit Lead Generation ─────────────────────────────────────

model AuditLead {
  id String @id @default(uuid())

  // Captured data
  url   String
  email String? // Null for lite, required for full

  // Auto-extracted data
  extractedName    String?
  extractedAddress String?
  extractedPhone   String?
  extractedFrom    String? // "schema" | "footer" | "contact" | "none"
  confidence       Int? // 0-100

  // Audit results
  liteScore Int?
  fullScore Int?
  auditType String // "lite" | "full"

  // Lead management
  status String @default("new") // new, contacted, converted, lost
  source String @default("web")

  // Engagement tracking
  viewedFullReport Boolean @default(false)

  metadata Json? // Store lite results

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
}

