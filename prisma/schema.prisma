generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model UserWallet {
  id           String        @id @default(uuid())
  clerkId      String        @unique
  balance      Int           @default(0) // Stored in 'credits' (100 = $1.00)
  transactions Transaction[]
}

model Transaction {
  id          String     @id @default(uuid())
  walletId    String
  wallet      UserWallet @relation(fields: [walletId], references: [id])
  amount      Int // Negative for usage, positive for top-up
  description String
  metadata    Json?
  createdAt   DateTime   @default(now())
}

model UserProfile {
  id          String  @id @default(uuid())
  clerkId     String  @unique
  websiteUrl  String?
  brandConfig Json? // Stores extracted logo, fonts, colors (The Mirror)

  // Encrypted Keys (The Vault)
  googleApiKey       String? // Google AI Studio / Gemini Key
  shopifyAccessToken String? // For Shopify sync
  redditApiKey       String? // For Reddit scraping/posting
  socialApiKeys      Json? // Encrypted map of other social keys (X, LinkedIn, etc.)

  // Vault Security (Phase 9.1)
  keyVersion         Int   @default(1) // Current encryption key version
  keyRotationHistory Json? // Audit trail of key rotations: [{ version, rotatedAt, rotatedBy }]

  integrations        Json? // Connection status & metadata
  onboardingCompleted Boolean @default(false)

  tasks KanbanTask[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model KanbanTask {
  id      String      @id @default(uuid())
  clerkId String
  profile UserProfile @relation(fields: [clerkId], references: [clerkId])

  title       String
  description String?
  status      String  @default("OBLIGATION") // OBLIGATION, EXECUTION, VALIDATION, ARCHIVE
  priority    String  @default("MEDIUM") // LOW, MEDIUM, HIGH, KINETIC

  dueDate   DateTime?
  payload   Json? // Mission data (tool options, specs)
  resultUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// v8.2 Mission Persistence
model Mission {
  id         String   @id @default(uuid())
  status     String // PENDING, RUNNING, COMPLETED, FAILED
  plan       Json?
  result     Json?
  audit      Json? // Independent Verification Report
  cost       Int // Total cost in credits
  agentCosts Json? // Phase 9.2: Per-agent cost breakdown { agentName: { tokens, cost, duration } }
  userId     String // Corresponds to clerkId/User ID
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// Phase 4: Cross-Mission Intelligence
model MissionLearning {
  id           String   @id @default(uuid())
  missionType  String // Classification: marketing, seo, content, research, etc.
  agentsUsed   String[] // List of agent names used in this mission
  success      Boolean // Whether mission completed successfully
  duration     Int // Duration in milliseconds
  retryCount   Int // Number of retries needed
  insights     String[] // Extracted insights and learnings
  qualityScore Float? // Quality score (0-100)
  failureMode  String? // If failed, what was the failure category
  timestamp    DateTime @default(now())

  @@index([missionType])
  @@index([success])
  @@index([timestamp])
}

// UNI-167: Task Queue & Scheduling System
model QueueJob {
  id           String    @id @default(uuid())
  queue        String // e.g. "missions", "agents", "maintenance"
  name         String // job name/type
  status       String    @default("waiting") // waiting, active, completed, failed, delayed
  priority     Int       @default(0) // BullMQ: lower = higher priority (0 is highest)
  payload      Json
  result       Json?
  error        String?
  attempts     Int       @default(0)
  maxAttempts  Int       @default(3)
  scheduledFor DateTime?
  startedAt    DateTime?
  completedAt  DateTime?
  userId       String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([queue, status])
  @@index([userId])
  @@index([scheduledFor])
}

model CronSchedule {
  id        String    @id @default(uuid())
  name      String // human-readable identifier
  pattern   String // cron expression: "0 */6 * * *"
  queue     String // target queue
  jobName   String // job type to create
  payload   Json
  isActive  Boolean   @default(true)
  nextRunAt DateTime?
  lastRunAt DateTime?
  userId    String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([name, userId])
  @@index([isActive, nextRunAt])
}

model DeadLetterEntry {
  id         String    @id @default(uuid())
  queue      String
  jobName    String
  bullmqId   String? // original BullMQ job ID
  payload    Json
  error      String
  attempts   Int
  failedAt   DateTime  @default(now())
  resolvedAt DateTime? // null = unresolved
  userId     String

  @@index([queue])
  @@index([userId])
  @@index([resolvedAt])
}

// UNI-169: API Gateway & External Integrations
// ─── API Gateway ────────────────────────────────────────────────────────

model ApiKey {
  id        String   @id @default(uuid())
  name      String
  keyHash   String   @unique // SHA-256 hash of API key
  keyPrefix String // First 15 chars (e.g., "gp_live_abc1234")
  scopes    String[] // ["missions:read", "agents:execute"]
  userId    String

  rateLimitTier String  @default("standard") // standard, premium, enterprise
  isActive      Boolean @default(true)

  lastUsedAt DateTime?
  expiresAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([keyPrefix])
}

model RateLimitBucket {
  id         String @id @default(uuid())
  identifier String // userId, IP, or API key hash
  endpoint   String // "/api/agents", "*" for global

  requestCount Int      @default(0)
  windowStart  DateTime

  @@unique([identifier, endpoint])
  @@index([windowStart])
}

// ─── Webhooks ───────────────────────────────────────────────────────────

model WebhookEndpoint {
  id     String @id @default(uuid())
  url    String
  secret String // Encrypted HMAC secret

  events   String[] // ["mission.completed", "wallet.topup"]
  isActive Boolean  @default(true)

  userId   String
  metadata Json?

  deliveries WebhookDelivery[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, isActive])
}

model WebhookDelivery {
  id         String          @id @default(uuid())
  endpointId String
  endpoint   WebhookEndpoint @relation(fields: [endpointId], references: [id])

  eventType String // "mission.completed"
  payload   Json

  status      String @default("pending") // pending, sent, failed, retrying
  attempts    Int    @default(0)
  maxAttempts Int    @default(3)

  responseCode Int?
  responseBody String?
  error        String?

  sentAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([endpointId, status])
  @@index([createdAt])
}

// ─── Connectors ─────────────────────────────────────────────────────────

model ConnectorState {
  id            String @id @default(uuid())
  connectorName String @unique // "stripe", "google-slides"

  isHealthy    Boolean   @default(true)
  failureCount Int       @default(0)
  lastFailure  DateTime?
  circuitState String    @default("closed") // closed, open, half-open

  metadata Json?

  lastCheckedAt DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([isHealthy, circuitState])
}

// ─── UNI-168: Monitoring Dashboard ─────────────────────────────────────

// Alert Rule Definition
model AlertRule {
  id          String  @id @default(uuid())
  name        String
  description String?

  // Rule type and configuration
  ruleType  String // threshold, rate_of_change
  metric    String // error_rate, queue_depth, cost_per_hour
  condition String // gt, lt, gte, lte
  threshold Float

  // Evaluation window
  windowMinutes Int @default(5)

  // Alert channels
  channels   String[] // ["webhook", "email"]
  webhookIds String[] // Webhook endpoint IDs

  // State
  isActive    Boolean   @default(true)
  isFiring    Boolean   @default(false)
  lastFiredAt DateTime?

  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  firings AlertFiring[]

  @@index([userId, isActive])
  @@index([isFiring])
}

// Alert Firing History
model AlertFiring {
  id     String    @id @default(uuid())
  ruleId String
  rule   AlertRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  triggeredAt DateTime  @default(now())
  resolvedAt  DateTime?

  metricValue Float
  message     String
  metadata    Json?

  notificationsSent String[]

  userId String

  @@index([ruleId, resolvedAt])
  @@index([triggeredAt])
  @@index([userId])
}

// Metrics Snapshot (time-series)
model MetricSnapshot {
  id String @id @default(uuid())

  timestamp DateTime // Rounded to nearest minute

  // Queue metrics
  queueDepth    Int @default(0)
  activeJobs    Int @default(0)
  failedJobs    Int @default(0)
  completedJobs Int @default(0)

  // Agent metrics
  activeAgents Int @default(0)
  idleAgents   Int @default(0)

  // Throughput
  jobsPerMinute Float @default(0)

  // Cost
  costPerHour     Float @default(0)
  tokensPerMinute Float @default(0)

  // Errors
  errorRate Float @default(0)

  userId String

  @@unique([timestamp, userId])
  @@index([userId, timestamp])
}

// Agent Status Tracking
model AgentStatus {
  id        String @id @default(uuid())
  agentName String

  status String @default("idle") // idle, active, failed, unknown

  currentJobId String?
  startedAt    DateTime?

  lastActiveAt        DateTime @default(now())
  consecutiveFailures Int      @default(0)

  avgDuration     Float @default(0)
  totalExecutions Int   @default(0)

  userId    String
  updatedAt DateTime @updatedAt

  @@unique([agentName, userId])
  @@index([userId, status])
}

// ─── UNI-171: Core CRM Module ──────────────────────────────────────

// Contact Model
model Contact {
  id     String @id @default(uuid())
  userId String

  // Basic Info
  firstName  String
  lastName   String
  email      String?
  phone      String?
  mobile     String?
  title      String? // Job title
  department String?

  // Company Relationship
  companyId String?
  company   Company? @relation(fields: [companyId], references: [id])
  isPrimary Boolean  @default(false)

  // Address
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String?

  // Metadata
  source    String? // Website, Referral, Cold Call
  leadScore Int      @default(0)
  status    String   @default("lead") // lead, prospect, customer, inactive
  tags      String[]

  // Relationships
  dealId       String?
  deal         Deal?         @relation(fields: [dealId], references: [id])
  interactions Interaction[]
  crmTasks     CRMTask[]
  invoices     Invoice[]

  // Custom Fields (JSONB for flexibility)
  customFields Json?

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String
  updatedBy String
  deletedAt DateTime?

  @@unique([email, userId])
  @@index([userId, status])
  @@index([companyId])
  @@index([leadScore])
  @@index([deletedAt])
}

// Company Model
model Company {
  id     String @id @default(uuid())
  userId String

  // Basic Info
  name          String
  legalName     String?
  industry      String?
  website       String?
  employeeCount String? // "1-10", "11-50", etc.
  annualRevenue String?

  // Contact Info
  phone String?
  email String?

  // Address (Headquarters)
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String?

  // Metadata
  status          String    @default("active") // active, inactive, prospect
  parentCompanyId String?
  parentCompany   Company?  @relation("CompanyHierarchy", fields: [parentCompanyId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  childCompanies  Company[] @relation("CompanyHierarchy")

  // Relationships
  contacts Contact[]
  deals    Deal[]
  invoices Invoice[]

  // Custom Fields
  customFields Json?

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String
  updatedBy String
  deletedAt DateTime?

  @@index([userId, status])
  @@index([parentCompanyId])
  @@index([industry])
  @@index([deletedAt])
}

// Deal (Pipeline) Model
model Deal {
  id     String @id @default(uuid())
  userId String

  // Basic Info
  name        String
  description String?
  value       Int // Stored in cents
  currency    String  @default("USD")

  // Pipeline
  stage             String // lead, qualified, proposal, negotiation, closed_won, closed_lost
  probability       Int       @default(0) // 0-100
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?

  // Relationships
  companyId String?
  company   Company?  @relation(fields: [companyId], references: [id])
  contacts  Contact[]
  ownerId   String // Assigned sales rep

  // Metadata
  source       String?
  lostReason   String?
  tags         String[]
  customFields Json?

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String
  updatedBy String
  deletedAt DateTime?

  @@index([userId, stage])
  @@index([ownerId])
  @@index([companyId])
  @@index([expectedCloseDate])
  @@index([deletedAt])
}

// Interaction Model
model Interaction {
  id     String @id @default(uuid())
  userId String

  // Basic Info
  type        String // call, email, meeting, note
  subject     String
  description String?
  outcome     String?

  // Timing
  scheduledAt DateTime?
  completedAt DateTime?
  duration    Int? // Duration in minutes

  // Relationships
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id])
  companyId String?
  dealId    String?

  // Participants
  participants String[] // Array of user IDs

  // Metadata
  status      String  @default("completed") // scheduled, completed, cancelled
  direction   String? // inbound, outbound
  attachments Json? // File URLs

  // Audit
  createdAt DateTime  @default(now())
  createdBy String
  deletedAt DateTime?

  @@index([userId, type])
  @@index([contactId])
  @@index([scheduledAt])
  @@index([deletedAt])
}

// CRM Task Model (separate from KanbanTask)
model CRMTask {
  id     String @id @default(uuid())
  userId String

  // Basic Info
  title       String
  description String?
  priority    String  @default("medium") // low, medium, high, urgent
  status      String  @default("todo") // todo, in_progress, completed, cancelled

  // Timing
  dueDate     DateTime?
  completedAt DateTime?
  reminderAt  DateTime?

  // Relationships
  contactId  String?
  contact    Contact? @relation(fields: [contactId], references: [id])
  companyId  String?
  dealId     String?
  assigneeId String

  // Metadata
  tags         String[]
  customFields Json?

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String
  deletedAt DateTime?

  @@index([userId, status])
  @@index([assigneeId])
  @@index([dueDate])
  @@index([contactId])
  @@index([deletedAt])
}

// ─── UNI-172: Inventory & Stock Management ─────────────────────────

// Product Model
model Product {
  id     String @id @default(uuid())
  userId String

  // Basic Info
  sku         String
  name        String
  description String?
  category    String?
  brand       String?

  // Pricing
  unitCost     Int    @default(0) // In cents
  sellingPrice Int    @default(0) // In cents
  currency     String @default("USD")

  // Inventory Tracking
  trackInventory  Boolean @default(true)
  stockLevel      Int     @default(0)
  reorderPoint    Int     @default(0)
  reorderQuantity Int     @default(0)

  // Physical Attributes
  weight     Float?
  dimensions Json? // { length, width, height, unit }
  barcode    String?

  // Status
  status String @default("active") // active, discontinued, out_of_stock

  // Relationships
  stockLocations        StockLocation[]
  inventoryTransactions InventoryTransaction[]
  invoiceLineItems      InvoiceLineItem[]

  // Custom Fields
  customFields Json?

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String
  updatedBy String
  deletedAt DateTime?

  @@unique([sku, userId])
  @@index([userId, status])
  @@index([category])
  @@index([stockLevel])
  @@index([deletedAt])
}

// Warehouse Model
model Warehouse {
  id     String @id @default(uuid())
  userId String

  // Basic Info
  name String
  code String
  type String @default("standard") // standard, fulfillment, retail

  // Address
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String?

  // Contact
  phone       String?
  email       String?
  managerName String?

  // Metadata
  status    String  @default("active") // active, inactive
  isDefault Boolean @default(false)

  // Relationships
  stockLocations        StockLocation[]
  inventoryTransactions InventoryTransaction[]

  // Custom Fields
  customFields Json?

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String
  updatedBy String
  deletedAt DateTime?

  @@unique([code, userId])
  @@index([userId, status])
  @@index([deletedAt])
}

// StockLocation Model
model StockLocation {
  id     String @id @default(uuid())
  userId String

  // Location Details
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  productId String
  product   Product @relation(fields: [productId], references: [id])

  // Physical Location
  zone  String?
  aisle String?
  rack  String?
  shelf String?
  bin   String?

  // Stock Info
  quantity          Int @default(0)
  reservedQuantity  Int @default(0)
  availableQuantity Int @default(0) // quantity - reservedQuantity

  // Metadata
  isPrimary Boolean @default(false)

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@unique([warehouseId, productId, zone, aisle, rack, shelf, bin])
  @@index([userId])
  @@index([warehouseId])
  @@index([productId])
  @@index([deletedAt])
}

// InventoryTransaction Model
model InventoryTransaction {
  id     String @id @default(uuid())
  userId String

  // Transaction Type
  type    String // in, out, transfer, adjustment, return
  subType String? // purchase, sale, damaged, lost, found

  // Product & Location
  productId String
  product   Product @relation(fields: [productId], references: [id])

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  // Quantity & Cost
  quantity  Int
  unitCost  Int? // In cents
  totalCost Int? // quantity * unitCost

  // Transfer Details (if type = transfer)
  fromWarehouseId String?
  toWarehouseId   String?

  // Reference
  referenceType String? // order, return, adjustment
  referenceId   String?

  // Metadata
  notes       String?
  performedBy String

  // Stock Levels (snapshot at time of transaction)
  stockBefore Int
  stockAfter  Int

  // Audit
  createdAt DateTime  @default(now())
  deletedAt DateTime?

  @@index([userId, type])
  @@index([productId])
  @@index([warehouseId])
  @@index([createdAt])
  @@index([referenceType, referenceId])
  @@index([deletedAt])
}

// ─── UNI-173: Invoicing & Financial Module ─────────────────────────

// Invoice Model
model Invoice {
  id     String @id @default(uuid())
  userId String

  // Invoice Number (Sequential per user)
  invoiceNumber String // Format: INV-2026-0001
  invoiceDate   DateTime @default(now())
  dueDate       DateTime

  // Customer Information
  customerId String?
  customer   Contact? @relation(fields: [customerId], references: [id])
  companyId  String?
  company    Company? @relation(fields: [companyId], references: [id])

  // Customer details snapshot (for historical accuracy)
  customerName    String
  customerEmail   String?
  customerAddress Json? // { line1, line2, city, state, postalCode, country }

  // Billing Details
  subtotal       Int    @default(0) // In cents
  taxRate        Float  @default(0) // e.g., 0.08 for 8%
  taxAmount      Int    @default(0) // In cents
  discountAmount Int    @default(0) // In cents
  total          Int    @default(0) // In cents
  currency       String @default("USD")

  // Payment Tracking
  status     String @default("draft") // draft, sent, paid, overdue, cancelled, refunded
  paidAmount Int    @default(0) // In cents
  balance    Int    @default(0) // total - paidAmount (in cents)

  // Stripe Integration
  stripeCustomerId      String?
  stripePaymentIntentId String?
  stripeInvoiceId       String?

  // Metadata
  notes  String? // Internal notes
  terms  String? // Payment terms displayed on invoice
  footer String? // Footer text on invoice
  customFields Json? // Additional custom fields

  // Relationships
  lineItems InvoiceLineItem[]
  payments  Payment[]

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String
  updatedBy String
  deletedAt DateTime?
  sentAt    DateTime? // When invoice was sent to customer
  paidAt    DateTime? // When fully paid

  @@unique([invoiceNumber, userId])
  @@index([userId, status])
  @@index([customerId])
  @@index([companyId])
  @@index([invoiceDate])
  @@index([dueDate])
  @@index([stripePaymentIntentId])
  @@index([deletedAt])
}

// Invoice Line Item Model
model InvoiceLineItem {
  id     String @id @default(uuid())
  userId String

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  // Line Item Details
  description String
  quantity    Int @default(1)
  unitPrice   Int // In cents
  amount      Int // quantity * unitPrice (in cents)

  // Optional Product Link
  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  // Tax handling per line item
  taxable   Boolean @default(true)
  taxRate   Float   @default(0)
  taxAmount Int     @default(0) // In cents

  // Metadata
  sortOrder    Int  @default(0)
  customFields Json?

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([invoiceId])
  @@index([productId])
  @@index([deletedAt])
}

// Payment Model
model Payment {
  id     String @id @default(uuid())
  userId String

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id])

  // Payment Details
  amount        Int      @default(0) // In cents
  paymentDate   DateTime @default(now())
  paymentMethod String // stripe, bank_transfer, cash, check, credit_card

  // Stripe Integration
  stripePaymentIntentId String?
  stripeChargeId        String?
  stripeRefundId        String?

  // Reference Numbers
  referenceNumber String? // Check number, transaction ID, etc.

  // Payment Status
  status String @default("completed") // pending, completed, failed, refunded

  // Metadata
  notes        String?
  customFields Json?

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String
  updatedBy String
  deletedAt DateTime?

  @@index([invoiceId])
  @@index([userId, status])
  @@index([stripePaymentIntentId])
  @@index([paymentDate])
  @@index([deletedAt])
}

// ─── UNI-174: Workflow Automation ───────────────────────────────────

// WorkflowTemplate Model
model WorkflowTemplate {
  id     String @id @default(uuid())
  userId String

  // Basic Info
  name         String
  description  String?
  type         String // approval, notification, automation
  triggerEvent String // invoice.created, deal.won, inventory.low

  // Workflow Definition (JSONB)
  steps Json // Array of workflow steps
  /**
   * Example steps structure:
   * [
   *   {
   *     stepId: "step-1",
   *     type: "approval",
   *     name: "Manager Approval",
   *     assigneeRole: "manager",
   *     condition: { field: "invoice.total", operator: "gt", value: 100000 },
   *     actions: [
   *       { type: "email", template: "approval-request" }
   *     ]
   *   },
   *   {
   *     stepId: "step-2",
   *     type: "notification",
   *     name: "Notify Finance",
   *     actions: [
   *       { type: "email", to: "finance@company.com" }
   *     ]
   *   }
   * ]
   */

  // Settings
  slaHours        Int?     // SLA in hours for completion
  escalationRules Json?    // Escalation logic
  isActive        Boolean  @default(true)

  // Instances
  instances WorkflowInstance[]

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String
  updatedBy String
  deletedAt DateTime?

  @@index([userId, isActive])
  @@index([type])
  @@index([triggerEvent])
  @@index([deletedAt])
}

// WorkflowInstance Model
model WorkflowInstance {
  id     String @id @default(uuid())
  userId String

  // Relationships
  templateId String
  template   WorkflowTemplate @relation(fields: [templateId], references: [id])

  // Instance Info
  referenceType String  // invoice, deal, etc.
  referenceId   String  // ID of the related entity
  status        String  @default("pending") // pending, in_progress, completed, cancelled, failed
  currentStepId String?

  // Steps Status
  stepsStatus Json // Track completion status of each step
  /**
   * Example:
   * {
   *   "step-1": { status: "approved", approvedBy: "user-123", approvedAt: "..." },
   *   "step-2": { status: "pending" }
   * }
   */

  // SLA Tracking
  slaDeadline DateTime?
  isOverdue   Boolean   @default(false)

  // Completion
  completedAt  DateTime?
  cancelledAt  DateTime?
  cancelReason String?

  // Metadata
  metadata Json? // Additional context for workflow execution

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status])
  @@index([templateId])
  @@index([referenceType, referenceId])
  @@index([slaDeadline, isOverdue])
  @@index([createdAt])
}

// Notification Model
model Notification {
  id     String @id @default(uuid())
  userId String

  // Notification Details
  type       String // email, in_app, sms, webhook
  channel    String? // For email: recipient email
  subject    String
  body       String
  templateId String?

  // Trigger
  triggerEvent  String // workflow.approved, invoice.overdue, etc.
  referenceType String?
  referenceId   String?

  // Delivery Status
  status        String    @default("pending") // pending, sent, failed, delivered, bounced
  sentAt        DateTime?
  deliveredAt   DateTime?
  failureReason String?
  retryCount    Int       @default(0)

  // Metadata
  metadata Json? // Additional context

  // Audit
  createdAt DateTime @default(now())
  readAt    DateTime? // For in_app notifications

  @@index([userId, status])
  @@index([type])
  @@index([sentAt])
  @@index([createdAt])
  @@index([referenceType, referenceId])
}

// ─── UNI-175: Reporting & Analytics ─────────────────────────────────

// Dashboard Model
model Dashboard {
  id     String @id @default(uuid())
  userId String

  // Dashboard Info
  name        String
  description String?
  type        String  @default("custom") // custom, template, system

  // Layout (JSONB)
  layout Json // Grid layout configuration
  /**
   * Example:
   * {
   *   columns: 12,
   *   widgets: [
   *     { id: "widget-1", x: 0, y: 0, w: 6, h: 4, type: "sales_chart", config: {...} },
   *     { id: "widget-2", x: 6, y: 0, w: 6, h: 4, type: "pipeline_status", config: {...} }
   *   ]
   * }
   */

  // Access
  isPublic   Boolean  @default(false)
  sharedWith String[] // User IDs who can access

  // Metadata
  isDefault Boolean @default(false)
  sortOrder Int     @default(0)

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String
  updatedBy String
  deletedAt DateTime?

  @@index([userId, type])
  @@index([isDefault])
  @@index([deletedAt])
}

// Report Model
model Report {
  id     String @id @default(uuid())
  userId String

  // Report Info
  name        String
  description String?
  type        String // sales, inventory, financial, crm, custom

  // Query Definition (JSONB)
  query Json // Report query configuration
  /**
   * Example:
   * {
   *   dataSource: "invoices",
   *   filters: [
   *     { field: "status", operator: "eq", value: "paid" },
   *     { field: "invoiceDate", operator: "gte", value: "2026-01-01" }
   *   ],
   *   groupBy: ["companyId"],
   *   aggregations: [
   *     { field: "total", function: "sum", alias: "totalRevenue" }
   *   ],
   *   orderBy: [{ field: "totalRevenue", direction: "desc" }],
   *   limit: 100
   * }
   */

  // Visualization
  chartType   String? // line, bar, pie, table, area, scatter
  chartConfig Json?   // Chart-specific settings

  // Scheduling
  isScheduled  Boolean   @default(false)
  schedule     String?   // Cron expression
  recipients   String[]  // Email addresses for scheduled delivery
  lastRunAt    DateTime?
  nextRunAt    DateTime?

  // Cache
  cachedResult Json?
  cachedAt     DateTime?
  cacheTTL     Int       @default(300) // Cache TTL in seconds

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String
  updatedBy String
  deletedAt DateTime?

  @@index([userId, type])
  @@index([isScheduled, nextRunAt])
  @@index([deletedAt])
}

// KPI Model
model KPI {
  id     String @id @default(uuid())
  userId String

  // KPI Info
  name        String
  description String?
  category    String // sales, inventory, financial, operations, crm

  // Calculation
  metric  String // revenue, conversion_rate, inventory_turnover, etc.
  formula Json   // Calculation logic
  /**
   * Example:
   * {
   *   dataSource: "invoices",
   *   aggregation: "sum",
   *   field: "total",
   *   filters: [{ field: "status", operator: "eq", value: "paid" }],
   *   timeRange: "current_month"
   * }
   */

  // Targets
  targetValue  Float?
  targetPeriod String? // daily, weekly, monthly, quarterly, yearly

  // Current Value (cached)
  currentValue     Float?
  previousValue    Float?
  changePercent    Float?
  lastCalculatedAt DateTime?

  // Display
  unit       String?  // currency, percentage, count, ratio
  format     String?  // Formatting rules (e.g., "$0,0.00", "0.00%")
  isVisible  Boolean  @default(true)
  sortOrder  Int      @default(0)

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String
  updatedBy String
  deletedAt DateTime?

  @@index([userId, category])
  @@index([isVisible])
  @@index([sortOrder])
  @@index([deletedAt])
}
