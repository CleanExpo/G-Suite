generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model UserWallet {
  id        String        @id @default(uuid())
  clerkId   String        @unique
  balance   Int           @default(0) // Stored in 'credits' (100 = $1.00)
  transactions Transaction[]
}

model Transaction {
  id          String     @id @default(uuid())
  walletId    String
  wallet      UserWallet @relation(fields: [walletId], references: [id])
  amount      Int        // Negative for usage, positive for top-up
  description String
  metadata    Json?
  createdAt   DateTime   @default(now())
}

model UserProfile {
  id                  String   @id @default(uuid())
  clerkId             String   @unique
  websiteUrl          String?
  brandConfig         Json?    // Stores extracted logo, fonts, colors (The Mirror)

  // Encrypted Keys (The Vault)
  googleApiKey        String?  // Google AI Studio / Gemini Key
  shopifyAccessToken  String?  // For Shopify sync
  redditApiKey        String?  // For Reddit scraping/posting
  socialApiKeys       Json?    // Encrypted map of other social keys (X, LinkedIn, etc.)

  // Vault Security (Phase 9.1)
  keyVersion          Int      @default(1)  // Current encryption key version
  keyRotationHistory  Json?    // Audit trail of key rotations: [{ version, rotatedAt, rotatedBy }]

  integrations        Json?    // Connection status & metadata
  onboardingCompleted Boolean  @default(false)

  tasks               KanbanTask[]

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model KanbanTask {
  id          String   @id @default(uuid())
  clerkId     String
  profile     UserProfile @relation(fields: [clerkId], references: [clerkId])
  
  title       String
  description String?
  status      String   @default("OBLIGATION") // OBLIGATION, EXECUTION, VALIDATION, ARCHIVE
  priority    String   @default("MEDIUM")     // LOW, MEDIUM, HIGH, KINETIC
  
  dueDate     DateTime?
  payload     Json?    // Mission data (tool options, specs)
  resultUrl   String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// v8.2 Mission Persistence
model Mission {
  id         String   @id @default(uuid())
  status     String   // PENDING, RUNNING, COMPLETED, FAILED
  plan       Json?
  result     Json?
  audit      Json?    // Independent Verification Report
  cost       Int      // Total cost in credits
  agentCosts Json?    // Phase 9.2: Per-agent cost breakdown { agentName: { tokens, cost, duration } }
  userId     String   // Corresponds to clerkId/User ID
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// Phase 4: Cross-Mission Intelligence
model MissionLearning {
  id              String   @id @default(uuid())
  missionType     String   // Classification: marketing, seo, content, research, etc.
  agentsUsed      String[] // List of agent names used in this mission
  success         Boolean  // Whether mission completed successfully
  duration        Int      // Duration in milliseconds
  retryCount      Int      // Number of retries needed
  insights        String[] // Extracted insights and learnings
  qualityScore    Float?   // Quality score (0-100)
  failureMode     String?  // If failed, what was the failure category
  timestamp       DateTime @default(now())

  @@index([missionType])
  @@index([success])
  @@index([timestamp])
}

// UNI-167: Task Queue & Scheduling System
model QueueJob {
  id           String    @id @default(uuid())
  queue        String                          // e.g. "missions", "agents", "maintenance"
  name         String                          // job name/type
  status       String    @default("waiting")   // waiting, active, completed, failed, delayed
  priority     Int       @default(0)           // BullMQ: lower = higher priority (0 is highest)
  payload      Json
  result       Json?
  error        String?
  attempts     Int       @default(0)
  maxAttempts  Int       @default(3)
  scheduledFor DateTime?
  startedAt    DateTime?
  completedAt  DateTime?
  userId       String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([queue, status])
  @@index([userId])
  @@index([scheduledFor])
}

model CronSchedule {
  id         String    @id @default(uuid())
  name       String                            // human-readable identifier
  pattern    String                            // cron expression: "0 */6 * * *"
  queue      String                            // target queue
  jobName    String                            // job type to create
  payload    Json
  isActive   Boolean   @default(true)
  nextRunAt  DateTime?
  lastRunAt  DateTime?
  userId     String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([name, userId])
  @@index([isActive, nextRunAt])
}

model DeadLetterEntry {
  id         String    @id @default(uuid())
  queue      String
  jobName    String
  bullmqId   String?                           // original BullMQ job ID
  payload    Json
  error      String
  attempts   Int
  failedAt   DateTime  @default(now())
  resolvedAt DateTime?                         // null = unresolved
  userId     String

  @@index([queue])
  @@index([userId])
  @@index([resolvedAt])
}
