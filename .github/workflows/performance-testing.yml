name: Performance & Security Testing (Load Testing + OWASP ZAP)

on:
  workflow_dispatch: # Manual trigger
  schedule:
    # Run weekly on Sunday at 00:00 UTC
    - cron: '0 0 * * 0'

jobs:
  k6-load-tests:
    name: k6 Load Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        test: [baseline, load, stress]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        working-directory: apps/web
        run: pnpm run build

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        working-directory: apps/backend
        run: |
          pip install uv
          uv sync

      - name: Start backend
        working-directory: apps/backend
        run: |
          uv run uvicorn src.api.main:app --port 8000 &
          sleep 10

      - name: Start frontend
        working-directory: apps/web
        run: |
          pnpm start &
          sleep 10

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run k6 ${{ matrix.test }} test
        run: |
          k6 run tests/performance/${{ matrix.test }}-test.js \
            --out json=results-${{ matrix.test }}.json

      - name: Upload k6 results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-${{ matrix.test }}-results
          path: results-${{ matrix.test }}.json
          retention-days: 30

  k6-spike-test:
    name: k6 Spike Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Only run spike test on manual trigger
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup services
        uses: ./.github/actions/setup-services  # Reusable action
        if: hashFiles('.github/actions/setup-services') != ''

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run k6 spike test
        run: |
          k6 run tests/performance/spike-test.js \
            --out json=results-spike.json

      - name: Upload spike test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-spike-results
          path: results-spike.json
          retention-days: 30

  owasp-zap-baseline:
    name: OWASP ZAP Baseline Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        working-directory: apps/web
        run: pnpm run build

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        working-directory: apps/backend
        run: |
          pip install uv
          uv sync

      - name: Start backend
        working-directory: apps/backend
        run: |
          uv run uvicorn src.api.main:app --port 8000 &
          sleep 10

      - name: Start frontend
        working-directory: apps/web
        run: |
          pnpm start &
          sleep 10

      - name: Create reports directory
        run: mkdir -p reports

      - name: Run ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-c .zap/baseline-scan.yaml -r reports/zap-baseline.html'
          fail_action: true
          allow_issue_writing: false

      - name: Upload ZAP Baseline Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-baseline-report
          path: reports/zap-baseline.html
          retention-days: 30

  owasp-zap-full-scan:
    name: OWASP ZAP Full Scan (Staging Only)
    runs-on: ubuntu-latest
    timeout-minutes: 90
    # Only run on manual trigger or scheduled run
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        working-directory: apps/web
        run: pnpm run build

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        working-directory: apps/backend
        run: |
          pip install uv
          uv sync

      - name: Start backend
        working-directory: apps/backend
        run: |
          uv run uvicorn src.api.main:app --port 8000 &
          sleep 10

      - name: Start frontend
        working-directory: apps/web
        run: |
          pnpm start &
          sleep 10

      - name: Create reports directory
        run: mkdir -p reports

      - name: Run ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-c .zap/full-scan.yaml -r reports/zap-full-scan.html'
          fail_action: true
          allow_issue_writing: false

      - name: Upload ZAP Full Scan Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-full-scan-report
          path: |
            reports/zap-full-scan.html
            reports/zap-full-scan-report.*
          retention-days: 30

  performance-security-summary:
    name: Testing Summary
    runs-on: ubuntu-latest
    needs: [k6-load-tests, owasp-zap-baseline]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "k6 Load Tests: ${{ needs.k6-load-tests.result }}"
          echo "OWASP ZAP Baseline: ${{ needs.owasp-zap-baseline.result }}"

      - name: Fail if any tests failed
        if: |
          needs.k6-load-tests.result == 'failure' ||
          needs.owasp-zap-baseline.result == 'failure'
        run: exit 1

      - name: Success summary
        if: |
          needs.k6-load-tests.result == 'success' &&
          needs.owasp-zap-baseline.result == 'success'
        run: |
          echo "âœ… All performance and security tests passed!"
          echo "- k6 load tests: Performance thresholds met"
          echo "- OWASP ZAP: No critical security issues found"
